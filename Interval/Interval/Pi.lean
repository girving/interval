import Interval.Interval.Conversion
import Interval.Interval.Scale
import Mathlib.Analysis.Real.Pi.Bounds

/-!
## Interval approximations of `π` and friends

See `scripts/gen-pi` for generation code.
-/

open Set
open scoped Real
namespace Interval

lemma pi_gt_314159265358979323846 : π > 3.14159265358979323846 := by
  pi_lower_bound [1408566531215635752536684707610/996006945974988813196889220419, 1795081291542588151225828989237/971490994428247162925515611254, 674839203517140255785416630894/344030042559210043730120480969, 1141230077035769616122479279193/573376000680765317288552999984, 48647360897799024884394536545/24353014721667842811986741077, 1631161635832209261075929346606/815826529613964950930173666883, 1210752412247537462252611443073/605421793271343877270278471699, 12945174151732412285272657540/6472708922782482585206568019, 1254207706957788797567733490261/627106804762933691783918173104, 310067230593919217218263055917/155033797701710440996907778545, 1509323830858493874427425069683/754662137403392931375786530673, 1456198227041542872839445748402/728099167061021019431350746535, 51792749572187768816929347865/25896375262161730074487245363, 1600042277006125449266349664421/800021142179874041510269936748, 1777343706521680991357097272388/888671854281900615348585690889, 1428601043325087123101460664704/714300521867721595751196872153, 1618799977319919104286608994109/809399988718083231704248803023, 1790928571799586569875417041716/895464285915869291837505804551, 1258009128729204821684880433025/629004564367425494318755273287, 1871330834381936834754809953177/935665417192018275251366573378, 1896490763693240237828177486659/948245381846886112201402768242, 1053343422914904752845261548932/526671711457489310728493944679, 1870051767222081196213791532515/935025883611056990923912510261, 1271830809836518700555998070107/635915404918262137485565603880, 1617117113892231554955441361492/808558556946116663452690977251, 1611024859534767650561202379852/805512429767384045939898190039, 496113661960490997215439038969/248056830980245515595677717716, 1924891505028186082935893653193/962445752514093057946013714701, 1653365038665211785994109730569/826682519332605896535469839117, 66864885944773576513331864524/33432442972386788292440807761, 1672261237350918463355644205965/836130618675459231901500558134, 1244841004512155296561519416913/622420502256077648322386594642, 1826061826357260842651969844180/913030913178630421341250580021, 514307346094250141904966366309/257153673047125070953558070092]

lemma pi_lt_314159265358979323847 : π < 3.14159265358979323847 := by
  pi_upper_bound [996006945974988813196889220419/704283265607817876268342353805, 1528727289839560965204682778132/827341247448235339825115450685, 913292375055240730430733739016/465592415232699379941083095141, 1645499627344295663165371448860/826730748193197246562598642091, 1843770496365204984304341838590/922997038538017719302356904659, 1801550067486787619910104613255/901046412076563538906954658887, 1419358929759005311881916875259/709732906462057848464800585018, 1974620922996075539636083349702/987329047688340185766875596479, 1703055998465468187256469972669/851532006704509629847652593643, 1872204633070305500751814237511/936103417906035924020944339290, 417873193942459288085664389516/208936658427256152595763823075, 682652985453241103432668703344/341326517825821018406534464423, 133449833823779055074913079027/66724918138531778002005419822, 1802627778656345399470040951302/901313893470514631525924232247, 1703298290358005799669120926811/851649146157524921098712387678, 1165765145162534233095510819562/582882572748696226264176946563, 171409596335374790028974750983/85704798173841927131273528183, 1916415282813016720770367166539/958207641423710780288743319187, 331175835363368698627932147613/165587917682427537107454982177, 1842175040313531583912899759640/921087520157799292786850855883, 493760775740610311406049235446/246880387870374408374537871617, 1639492360311230529633260363591/819746180155672751777652349511, 1743864522386087812132460629377/871932261193059192729689867963, 24351885390057283142606021981/12175942695028694938275012643, 1393660753917060167524729859317/696830376958530847311606012861, 1199992079080594763280056747597/599996039540297546000874209594, 356242218080878554415612856627/178121109040439289406277007189, 1258407911404392877131542115857/629203955702196449338393661579, 1928835914023314404795982456526/964417957011657206525949495577, 1182695499413497707067870088277/591347749706748854166715368922, 1909465313407151114552936023714/954732656703575557531874429185, 1961572162124030319678167149025/980786081062015159904677606876, 931266043180727152209784389970/465633021590363576112677467451, 1670978975783135072358731367231/835489487891567536182857979589]

/-- Optimal `Interval` approximation of `π` -/
@[irreducible] def pi : Interval :=
  ⟨⟨7244019458077122842, 9223372036854775747, by decide +kernel⟩,
   ⟨7244019458077122843, 9223372036854775747, by decide +kernel⟩, by decide +kernel⟩

@[approx] lemma approx_pi : π ∈ approx pi := by
  have n : pi.lo ≠ nan := by decide +kernel
  have lo : pi.lo.valq = 3622009729038561421/1152921504606846976 := by decide +kernel
  have hi : pi.hi.valq = 7244019458077122843/2305843009213693952 := by decide +kernel
  simp only [approx, n, if_false, mem_Icc, ← Floating.coe_valq, lo, hi, Rat.cast_div,
    Rat.cast_ofNat]
  exact ⟨le_trans (by norm_num) pi_gt_314159265358979323846.le,
         le_trans pi_lt_314159265358979323847.le (by norm_num)⟩

/-- Optimal `Interval` approximation of `π⁻¹` -/
@[irreducible] def inv_pi : Interval :=
  ⟨⟨5871781006564002452, 9223372036854775744, by decide +kernel⟩,
   ⟨5871781006564002453, 9223372036854775744, by decide +kernel⟩, by decide +kernel⟩

@[approx] lemma approx_inv_pi : π⁻¹ ∈ approx inv_pi := by
  have n : inv_pi.lo ≠ nan := by decide +kernel
  have lo : inv_pi.lo.valq = 1467945251641000613/4611686018427387904 := by decide +kernel
  have hi : inv_pi.hi.valq = 5871781006564002453/18446744073709551616 := by decide +kernel
  simp only [approx, n, if_false, mem_Icc, ← Floating.coe_valq, lo, hi, Rat.cast_div,
    Rat.cast_ofNat]
  rw [le_inv_comm₀ (by norm_num) Real.pi_pos, inv_le_comm₀ Real.pi_pos (by norm_num)]
  exact ⟨le_trans pi_lt_314159265358979323847.le (by norm_num),
         le_trans (by norm_num) pi_gt_314159265358979323846.le⟩

-- `π / 2`, `π / 4`, and inverses
@[irreducible] def pi_div_2 : Interval := pi.div2
@[irreducible] def pi_div_4 : Interval := pi_div_2.div2
@[irreducible] def two_div_pi : Interval := inv_pi.scaleB 1
@[irreducible] def four_div_pi : Interval := inv_pi.scaleB 2

@[approx] lemma approx_pi_div_2 : π / 2 ∈ approx pi_div_2 := by
  rw [pi_div_2]; approx
@[approx] lemma approx_pi_div_4 : π / 4 ∈ approx pi_div_4 := by
  rw [pi_div_4, (by norm_num : (4 : ℝ) = 2 * 2), ← div_div]; approx
@[approx] lemma approx_two_div_pi : 2 / π ∈ approx two_div_pi := by
  rw [two_div_pi, div_eq_inv_mul, (by norm_num : (2 : ℝ) = 2^1)]
  apply mem_approx_scaleB; approx
@[approx] lemma approx_four_div_pi : 4 / π ∈ approx four_div_pi := by
  rw [four_div_pi, div_eq_inv_mul, (by norm_num : (4 : ℝ) = 2^2)]
  apply mem_approx_scaleB; approx
